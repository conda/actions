name: Check CLA
description: Reacts to new PRs and check if the contributor has previously signed the conda contributor license agreement (CLA).
inputs:
  label:
    description: Label to apply to contributor's PR once the CLA is signed.
    default: cla-signed
  repository:
    description: Repository in which to create PR adding CLA signature.
    default: conda/cla
  path:
    description: Path to the CLA signees file within the provided `repository`.
    default: .cla-signers
  magic-command:
    description: Magic word to trigger the action via a comment.
    default: '@conda-bot check'
  author:
    description: Git-format author to use for the CLA commits.
    default: Conda Bot <18747875+conda-bot@users.noreply.github.com>
  token:
    description: |
      GitHub token to comment on PRs, change PR labels, and modify the commit status in the current repository.
      Fine-grained PAT: `pull_request: write; statuses: write`
    default: ${{ github.token }}
  pr-token:
    description: |
      GitHub token to create pull request in the `repository`.
      Fine-grained PAT: `pull_request: write`
    # default: ${{ inputs.token }}
  fork-token:
    description: |
      GitHub token to create and push to a `repository` fork.
      Fine-grained PAT: `administration: write; contents: write`
    # default: ${{ inputs.pr-token }}
  contributor-id:
    description: Contributor ID to check for CLA signature.
    default: ${{ github.event.pull_request.user.id || github.event.issue.user.id }}
  contributor-login:
    description: Contributor login to check for CLA signature.
    default: ${{ github.event.pull_request.user.login || github.event.issue.user.login }}
  commit-status-context:
    description: Commit status label/identifier.
    default: CLA check
  comment-blurb:
    description: Comment to add to PRs for contributors who have not signed the CLA.

runs:
  using: composite
  steps:
    - name: Set Comment Reaction [eyes]
      uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
      if: github.event_name == 'issue_comment'
      with:
        token: ${{ inputs.token }}
        comment-id: ${{ github.event.comment.id }}
        reactions: eyes
        reactions-edit-mode: replace

    - name: Set Commit Status [pending]
      uses: conda/actions/set-commit-status@7873f9d7c90877290866eb893b8f6eff2e88429a # v25.1.2
      with:
        token: ${{ inputs.token }}
        context: ${{ inputs.commit-status-context }}
        description: Checking conda CLA...
        state: pending

    - name: Read CLA Signees
      id: read-cla
      uses: conda/actions/read-file@7873f9d7c90877290866eb893b8f6eff2e88429a # v25.1.2
      with:
        path: https://raw.githubusercontent.com/${{ inputs.repository }}/main/${{ inputs.path }}
        parser: json
        default: '{}'

    - name: Detect Signature
      id: detect-signature
      shell: bash
      run: echo signed=${{ contains(fromJSON(steps.read-cla.outputs.content), inputs.contributor-id) }} >> $GITHUB_OUTPUT

    - name: Add PR Label
      uses: actions-ecosystem/action-add-labels@18f1af5e3544586314bbe15c0273249c770b2daf # v1.1.3
      if: inputs.label && steps.detect-signature.outputs.signed == 'true' && !contains(github.event.pull_request.labels || github.event.issue.labels, inputs.label)
      with:
        github_token: ${{ inputs.token }}
        labels: ${{ inputs.label }}

    - name: Remove PR Label
      uses: actions-ecosystem/action-remove-labels@2ce5d41b4b6aa8503e285553f75ed56e0a40bae0 # v1.3.0
      if: inputs.label && steps.detect-signature.outputs.signed == 'false' && contains(github.event.pull_request.labels || github.event.issue.labels, inputs.label)
      with:
        github_token: ${{ inputs.token }}
        labels: ${{ inputs.label }}

    # cloning upstream (not fork) since main branch is not in sync
    - name: Clone CLA Repository
      if: steps.detect-signature.outputs.signed == 'false'
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        repository: ${{ inputs.repository }}
        path: .github_cache/actions/cla

    - name: Create Fork
      id: create-fork
      if: steps.detect-signature.outputs.signed == 'false'
      uses: conda/actions/create-fork@7873f9d7c90877290866eb893b8f6eff2e88429a # v25.1.2
      with:
        repository: ${{ inputs.repository }}
        token: ${{ inputs.fork-token || inputs.pr-token || inputs.token }}

    - name: Setup Python
      if: steps.detect-signature.outputs.signed == 'false'
      uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
      with:
        python-version: '>=3.9'

    - name: Add Contributor Signature
      if: steps.detect-signature.outputs.signed == 'false'
      shell: bash
      run: >
        python ${{ github.action_path }}/check_cla.py
        .github_cache/actions/cla/${{ inputs.path }}
        --id=${{ inputs.contributor-id }}
        --login=${{ inputs.contributor-login }}

    - name: Diff
      shell: bash
      run: git diff

    - name: Create PR
      id: pull
      if: steps.detect-signature.outputs.signed == 'false'
      uses: peter-evans/create-pull-request@67ccf781d68cd99b580ae25a5c18a1cc84ffff1f # v7.0.6
      with:
        path: .github_cache/actions/cla
        # push to the fork
        branch-token: ${{ inputs.fork-token || inputs.pr-token || inputs.token }}
        push-to-fork: ${{ steps.create-fork.outputs.fork }}
        branch: cla-${{ inputs.contributor-id }}
        commit-message: ðŸ¤– Add ${{ inputs.contributor-login }} (${{ inputs.contributor-id }}) as CLA signee
        author: ${{ inputs.author }}
        committer: ${{ inputs.author }}
        # create PR
        token: ${{ inputs.pr-token || inputs.token }}
        delete-branch: true
        title: ðŸ¤– Add ${{ inputs.contributor-login }} (${{ inputs.contributor-id }}) as CLA signee
        body: Xref ${{ github.event.pull_request.html_url || github.event.issue.html_url }}

    - name: Create Comment
      uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
      if: steps.detect-signature.outputs.signed == 'false'
      with:
        number: ${{ github.event.number || github.event.issue.number }}
        # GitHub flavored markdown reinvents how paragraphs work, adjoined lines of text are not
        # concatenated so instead we rely on YAML multi-line + extra newlines
        message: >-
          [cla]: https://conda.io/en/latest/contributing.html#conda-contributor-license-agreement


          ${{ inputs.comment-blurb }}


          We require contributors to sign our [Contributor License Agreement][cla] and we don't
          have one on file for @${{ inputs.contributor-login }} (${{ inputs.contributor-id }}).


          In order for us to review and merge your code, please e-sign the
          [Contributor License Agreement PDF][cla]. We then need to manually verify your
          signature, merge the PR (${{ steps.pull.outputs.pull-request-url }}), and ping the bot
          to refresh the PR.


          <details>

          <summary>Commands</summary>


          Trigger actions by commenting on this PR:


          - `${{ inputs.magic-command }}` will check whether a CLA has been signed for this PR author


          </details>
        GITHUB_TOKEN: ${{ inputs.token }}

    - name: Set Commit Status [success]
      if: steps.detect-signature.outputs.signed == 'true'
      uses: conda/actions/set-commit-status@7873f9d7c90877290866eb893b8f6eff2e88429a # v25.1.2
      with:
        token: ${{ inputs.token }}
        context: ${{ inputs.commit-status-context }}
        description: CLA signed, thank you!
        state: success

    - name: Set Commit Status [error]
      if: steps.detect-signature.outputs.signed == 'false'
      uses: conda/actions/set-commit-status@7873f9d7c90877290866eb893b8f6eff2e88429a # v25.1.2
      with:
        token: ${{ inputs.token }}
        context: ${{ inputs.commit-status-context }}
        description: Please follow the details link to sign the conda CLA. â†’
        target_url: https://conda.io/en/latest/contributing.html#conda-contributor-license-agreement
        state: error

    - name: Set Comment Reaction [hooray/confused]
      uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
      if: github.event_name == 'issue_comment'
      with:
        token: ${{ inputs.token }}
        comment-id: ${{ github.event.comment.id }}
        reactions: ${{ steps.detect-signature.outputs.signed == 'true' && 'hooray' || 'confused' }}
        reactions-edit-mode: replace

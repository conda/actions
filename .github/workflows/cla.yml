name: CLA

on:
  # Triggered by comment to re-check CLA status
  issue_comment:
    types:
      - created

  # Triggered after CLA Trigger workflow completes (safer than pull_request_target)
  workflow_run:
    workflows: ["CLA Trigger"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  statuses: write
  actions: read  # Required to download artifacts from workflow_run

jobs:
  check:
    if: >-
      !github.event.repository.fork
      && (
        (
          github.event_name == 'issue_comment'
          && github.event.issue.pull_request
          && github.event.comment.body == '@conda-bot check'
        )
        || (
          github.event_name == 'workflow_run'
          && github.event.workflow_run.conclusion == 'success'
        )
      )
    runs-on: ubuntu-latest
    steps:
      # For workflow_run events, download PR info from artifact
      - name: Download PR info
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: pr-info
          path: pr-info/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set PR context from artifact
        if: github.event_name == 'workflow_run'
        id: pr-context
        run: |
          echo "number=$(cat pr-info/number)" >> $GITHUB_OUTPUT
          echo "author=$(cat pr-info/author)" >> $GITHUB_OUTPUT
          echo "url=$(cat pr-info/url)" >> $GITHUB_OUTPUT
          echo "sha=$(cat pr-info/sha)" >> $GITHUB_OUTPUT

      - name: Check CLA
        uses: conda/actions/check-cla@f05161c6e6e37a49b17c8e0b436197b53830318a # v25.9.2
        with:
          # [required]
          # A token with ability to comment, label, and modify the commit status
          # (`pull_request: write` and `statuses: write` for fine-grained PAT; `repo` for classic PAT)
          # (default: secrets.GITHUB_TOKEN)
          token: ${{ secrets.CLA_ACTION_TOKEN }}
          # [required]
          # Label to apply to contributor's PR once CLA is signed
          label: cla-signed

          # [required]
          # Token for opening signee PR in the provided `cla_repo`
          # (`pull_request: write` for fine-grained PAT; `repo` and `workflow` for classic PAT)
          cla_token: ${{ secrets.CLA_FORK_TOKEN }}

          # PR context from workflow_run artifact (if applicable)
          pr_number: ${{ steps.pr-context.outputs.number }}
          pr_author: ${{ steps.pr-context.outputs.author }}
          pr_url: ${{ steps.pr-context.outputs.url }}
          pr_sha: ${{ steps.pr-context.outputs.sha }}

